<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.3.4">Jekyll</generator><link href="http://localhost:4000/feed.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" /><updated>2024-11-20T11:24:20-05:00</updated><id>http://localhost:4000/feed.xml</id><title type="html">corey.sh</title><entry><title type="html">A Simple Workaround for ProtonVPN’s DNS Pool Removals</title><link href="http://localhost:4000/blogs/2024/11/17/protonvpn-dns-pool-removal.html" rel="alternate" type="text/html" title="A Simple Workaround for ProtonVPN’s DNS Pool Removals" /><published>2024-11-17T00:00:00-05:00</published><updated>2024-11-17T00:00:00-05:00</updated><id>http://localhost:4000/blogs/2024/11/17/protonvpn-dns-pool-removal</id><content type="html" xml:base="http://localhost:4000/blogs/2024/11/17/protonvpn-dns-pool-removal.html"><![CDATA[<figure>
    <img src="/assets/images/blogs/2024-11-17-protonvpn-dns-pool-removal/protonvpn_announcement.png" width="90%" alt="pictureName" />
    <figcaption><i>ProtonVPN Announcement</i></figcaption>
</figure>
<p>ProtonVPN recently announced they are decommissioning the legacy DNS entries for country-based IP pools like “us.protonvpn.net” which are used in older OpenVPN configuration profiles. If you’re using a newer profile, you’re likely using a fixed IP address instead, so this may not apply to you.</p>

<p>This change creates an issue for my setup. I use ProtonVPN with OpenVPN on my pfSense firewall, where I have a cron job that restarts the OpenVPN service according to the schedule I set. The cron job ensures that I get a new random IP address from ProtonVPN’s DNS pool each time the service restarts. However, with the removal of the legacy DNS pools, this option is no longer available.</p>

<p>ProtonVPN recommends switching to WireGuard, which offers better performance, security, and a more efficient codebase. However, the same issue persists with WireGuard: since your private key is tied to a specific ProtonVPN server, you won’t have the option to randomly rotate IPs. Instead, you’ll need to configure multiple tunnels in pfSense and switch between them manually.</p>

<h1 id="the-solution">The Solution</h1>

<p>To solve this problem, I’ve developed a simple solution for OpenVPN users relying on ProtonVPN’s DNS pools. I’ve created a Cloudflare Worker that is scheduled to run every minute, fetching a random row from a D1 SQL database and updating the “us.protonvpn” A record at corey.sh with the corresponding IP address. Currently, the IP addresses in the D1 database are manually populated using a script that queries Proton’s API and extracts the node IPs. In the near future, I plan to automate this process with an additional worker, ensuring that the database always contains up-to-date node information. This allows me to continue rotating IP addresses without disruption.</p>

<figure>
<figcaption><i>Cloudflare Worker code</i></figcaption>
<pre><code class="language-javascript">export default {
  async scheduled(event, env) {
    const { zoneId, recordId, authToken, vpnNodesDb, cloudflareEmail } = env;
    const cloudflareUrl = 
     `https://api.cloudflare.com/client/v4/zones/${zoneId}/dns_records/${recordId}`;
    const queryRandomAddress = 
     `SELECT * FROM protonVpnNodesUs ORDER BY RANDOM() LIMIT 1`;
    const vpnNodeUs = await vpnNodesDb.prepare(queryRandomAddress).first();
    const dateTime = new Date().toISOString();

    const requestData = {
      comment: `${dateTime}: Worker updated node address.`,
      name: "us.protonvpn",
      proxied: false,
      settings: {},
      tags: [],
      ttl: 60,
      content: vpnNodeUs.ipAddress,
      type: "A",
    };

    const headers = {
      "Content-Type": "application/json",
      "X-Auth-Email": cloudflareEmail,
      Authorization: `Bearer ${authToken}`,
    };

    await fetch(cloudflareUrl, {
      method: "PATCH",
      headers: headers,
      body: JSON.stringify(requestData),
    })
      .then((response) =&gt; response.json())
      .then((data) =&gt; console.log("Success:", data))
      .catch((error) =&gt; console.error("Error:", error));

},
};
</code></pre>

</figure>

<h1 id="pfsense-configuration">pfSense Configuration</h1>

<p>If you’d like to replicate a similar setup and randomize your OpenVPN connections, you can configure it by following these instructions. This guide assumes that OpenVPN is already set up on your firewall and configured to use ProtonVPN.</p>

<p>Navigate to VPN &gt; OpenVPN &gt; Clients. Select your Client and input the following information.</p>

<figure>
Server host or address:
<pre><code class="language">us.protonvpn.corey.sh</code></pre>

Custom Options:

<pre><code class="language">tun-mtu 1500;
tun-mtu-extra 32;
mssfix 1450;
reneg-sec 0;
remote-cert-tls server;
remote us.protonvpn.corey.sh 80;
remote us.protonvpn.corey.sh 5060;
remote us.protonvpn.corey.sh 4569;
remote us.protonvpn.corey.sh 51820;
</code></pre>
<figcaption><i>pfSense OpenVPN client configuration</i></figcaption>
</figure>

<h1 id="cron-job-setup">Cron job setup</h1>

<p>To set up a cron job on your pfSense firewall, you’ll first need to install the ‘cron’ package. You can do this by navigating to System &gt; Package Manager &gt; Available Packages, then searching for ‘cron.’ Once the package is installed, go to Services &gt; Cron and create a new cron schedule.</p>

<p>Configure the schedule according to your preferences, and for the command, enter the following:</p>

<pre><code class="language">/usr/local/sbin/pfSsh.php playback svc restart openvpn client 3</code></pre>

<p>Be sure to replace the ‘3’ with the appropriate client number for your setup. In my case, ‘3’ corresponds to the third OpenVPN client configured on the firewall.</p>

<p>While I plan to switch to WireGuard, this setup provides a reliable temporary solution that anyone can use in the meantime.</p>]]></content><author><name></name></author><category term="blogs" /><summary type="html"><![CDATA[Learn how to fix the 'us.protonvpn.net' DNS pool removal issue with this simple workaround, and setup pfSense to rotate random OpenVPN IP addresses.]]></summary></entry><entry><title type="html">Example Project 1</title><link href="http://localhost:4000/projects/2024/11/17/Example-Project-1.html" rel="alternate" type="text/html" title="Example Project 1" /><published>2024-11-17T00:00:00-05:00</published><updated>2024-11-17T00:00:00-05:00</updated><id>http://localhost:4000/projects/2024/11/17/Example-Project-1</id><content type="html" xml:base="http://localhost:4000/projects/2024/11/17/Example-Project-1.html"><![CDATA[<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec posuere vulputate lectus nec faucibus.
Integer tempus tempor eros. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos.
Ut eget gravida sem. Aenean nec viverra libero. Maecenas sit amet malesuada velit. Nulla ultrices sollicitudin libero, a viverra nulla.
Praesent id neque euismod, iaculis ex vel, ultricies est. Morbi sollicitudin vitae ipsum in sollicitudin.
Ut dui diam, semper eu vestibulum vel, lacinia mollis magna. Nullam nisi quam, semper ut porttitor sagittis,
porttitor ac ex. Pellentesque ut fringilla justo. Sed sagittis, quam ut consectetur facilisis, mauris lacus venenatis orci,
nec pellentesque nulla nibh in turpis. Maecenas rhoncus tincidunt viverra. In lacinia consequat libero eget euismod.</p>

<figure>
    <img src="/assets/images/projects/2024-11-17-Example-Project-1/placeholder_image.png" width="90%" alt="pictureName" />
    <figcaption>Image Caption</figcaption>
</figure>
<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec posuere vulputate lectus nec faucibus. 
Integer tempus tempor eros. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. 
Ut eget gravida sem. Aenean nec viverra libero. Maecenas sit amet malesuada velit. Nulla ultrices sollicitudin libero, a viverra nulla. 
Praesent id neque euismod, iaculis ex vel, ultricies est. Morbi sollicitudin vitae ipsum in sollicitudin. 
Ut dui diam, semper eu vestibulum vel, lacinia mollis magna. Nullam nisi quam, semper ut porttitor sagittis, 
porttitor ac ex. Pellentesque ut fringilla justo. Sed sagittis, quam ut consectetur facilisis, mauris lacus venenatis orci, 
nec pellentesque nulla nibh in turpis. Maecenas rhoncus tincidunt viverra. In lacinia consequat libero eget euismod.</p>
<figure>
    <img src="/assets/images/projects/2024-11-17-Example-Project-1/placeholder_image.png" width="90%" alt="pictureName" />
    <figcaption>Image Caption</figcaption>
</figure>
<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec posuere vulputate lectus nec faucibus. 
Integer tempus tempor eros. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. 
Ut eget gravida sem. Aenean nec viverra libero. Maecenas sit amet malesuada velit. Nulla ultrices sollicitudin libero, a viverra nulla. 
Praesent id neque euismod, iaculis ex vel, ultricies est. Morbi sollicitudin vitae ipsum in sollicitudin. 
Ut dui diam, semper eu vestibulum vel, lacinia mollis magna. Nullam nisi quam, semper ut porttitor sagittis, 
porttitor ac ex. Pellentesque ut fringilla justo. Sed sagittis, quam ut consectetur facilisis, mauris lacus venenatis orci, 
nec pellentesque nulla nibh in turpis. Maecenas rhoncus tincidunt viverra. In lacinia consequat libero eget euismod.</p>
<figure>
    <img src="/assets/images/projects/2024-11-17-Example-Project-1/placeholder_image.png" width="90%" alt="pictureName" />
    <figcaption>Image Caption</figcaption>
</figure>
<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec posuere vulputate lectus nec faucibus. 
Integer tempus tempor eros. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. 
Ut eget gravida sem. Aenean nec viverra libero. Maecenas sit amet malesuada velit. Nulla ultrices sollicitudin libero, a viverra nulla. 
Praesent id neque euismod, iaculis ex vel, ultricies est. Morbi sollicitudin vitae ipsum in sollicitudin. 
Ut dui diam, semper eu vestibulum vel, lacinia mollis magna. Nullam nisi quam, semper ut porttitor sagittis, 
porttitor ac ex. Pellentesque ut fringilla justo. Sed sagittis, quam ut consectetur facilisis, mauris lacus venenatis orci, 
nec pellentesque nulla nibh in turpis. Maecenas rhoncus tincidunt viverra. In lacinia consequat libero eget euismod.
Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec posuere vulputate lectus nec faucibus.</p>
<figure>
    <img src="/assets/images/projects/2024-11-17-Example-Project-1/placeholder_image.png" width="90%" alt="pictureName" />
    <figcaption>Image Caption</figcaption>
</figure>
<p>Integer tempus tempor eros. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. 
Ut eget gravida sem. Aenean nec viverra libero. Maecenas sit amet malesuada velit. Nulla ultrices sollicitudin libero, a viverra nulla. 
Praesent id neque euismod, iaculis ex vel, ultricies est. Morbi sollicitudin vitae ipsum in sollicitudin. 
Ut dui diam, semper eu vestibulum vel, lacinia mollis magna. Nullam nisi quam, semper ut porttitor sagittis, 
porttitor ac ex. Pellentesque ut fringilla justo. Sed sagittis, quam ut consectetur facilisis, mauris lacus venenatis orci, 
nec pellentesque nulla nibh in turpis. Maecenas rhoncus tincidunt viverra. In lacinia consequat libero eget euismod.</p>]]></content><author><name></name></author><category term="projects" /><summary type="html"><![CDATA[Example Project]]></summary></entry></feed>